var all_subs = ['composer', 'baroque', 'classicalmusic', 'contemporary', 'concertband', 'choralmusic', 'ChamberMusic', 'EarlyMusic', 'earlymusicalnotation', 'ElitistClassical', 'icm', 'Opera', 'orchestra', 'acidhouse', 'ambientmusic', 'AStateOfTrance', 'AtmosphericDnB', 'BigBeat', 'boogiemusic', 'breakbeat', 'breakcore', 'chicagohouse', 'chillout', 'Chipbreak', 'Chiptunes', 'complextro', 'cxd', 'darkstep', 'deephouse', 'DnB', 'DubStep', 'EDM', 'EBM', 'electronicdancemusic', 'ElectronicJazz', 'ElectronicBlues', 'electrohiphop', 'electrohouse', 'electronicmagic', 'ElectronicMusic', 'electropop', 'electroswing', 'ExperimentalMusic', 'fidget', 'filth', 'frenchelectro', 'frenchhouse', 'funkhouse', 'fusiondancemusic', 'futurebeats', 'FutureFunkAirlines', 'FutureGarage', 'futuresynth', 'gabber', 'glitch', 'glitchop', 'Grime', 'happyhardcore', 'hardhouse', 'hardstyle', 'house', 'idm', 'industrialmusic', 'ItaloDisco', 'latinhouse', 'LiquidDubstep', 'mashups', 'melodichouse', 'minimal', 'mixes', 'moombahcore', 'nightstep', 'OldskoolRave', 'Outrun', 'theOverload', 'partymusic', 'plunderphonics', 'psybient', 'PsyBreaks', 'psytrance', 'purplemusic', 'raggajungle', 'RealDubstep', 'skweee', 'swinghouse', 'tech_house', 'Techno', 'Trance', 'tranceandbass', 'trap', 'tribalbeats', 'TropicalHouse', 'ukfunky', 'witchhouse', 'wuuB', '80sHardcorePunk', '90sAlternative', '90sPunk', '90sRock', 'AlternativeRock', 'AltCountry', 'AORMelodic', 'ausmetal', 'BlackMetal', 'bluegrass', 'Blues', 'bluesrock', 'Boneyard', 'CanadianClassicRock', 'CanadianMusic', 'ClassicRock', 'country', 'Christcore', 'crunkcore', 'deathcore', 'deathmetal', 'Djent', 'DoomMetal', 'Drone', 'Emo', 'EmoScreamo', 'epicmetal', 'flocked', 'folk', 'folkmetal', 'folkpunk', 'folkrock', 'folkunknown', 'GaragePunk', 'GothicMetal', 'Grunge', 'hardcore', 'HardRock', 'horrorpunk', 'indie_rock', 'jrock', 'krautrock', 'LadiesofMetal', 'MathRock', 'melodicdeathmetal', 'MelodicMetal', 'MetalNews', 'Metalmusic', 'metal', 'metalcore', 'ModernRockMusic', 'monsterfuzz', 'neopsychedelia', 'NewWave', 'noiserock', 'numetal', 'pianorock', 'poppunkers', 'PostHardcore', 'PostRock', 'powermetal', 'powerpop', 'ProgMetal', 'progrockmusic', 'PsychedelicRock', 'punk', 'Punkskahardcore', 'Punk_Rock', 'raprock', 'Rock', 'shoegaze', 'stonerrock', 'symphonicblackmetal', 'symphonicmetal', 'synthrock', 'ThrowbackCore', 'truethrash', 'Truemetal', 'OutlawCountry', 'WomenRock', '80sHipHop', '90sHipHop', 'altrap', 'asianrap', 'backpacker', 'backspin', 'BayRap', 'ChapHop', 'ChiefKeef', 'DrillandBop', 'Emo_Trap', 'Gfunk', 'hiphopheads', 'hiphopheadsnorthwest', 'hiphop101', 'MemphisRap', 'NYrap', 'Rap', 'raprock', 'rapverses', 'rhymesandbeats', 'trapmuzik', 'ukhiphopheads', 'undergroundchicago', 'LofiHipHop', '2010smusic', '2000smusic', '90sMusic', '80sremixes', '80sMusic', '70sMusic', '60sMusic', '50sMusic', 'AfricanMusic', 'afrobeat', 'balkanbrass', 'balkanmusic', 'brazilianmusic', 'britpop', 'CroatianMusic', 'Flamenco', 'Irishmusic', 'ItalianMusic', 'jpop', 'KoreanRock', 'kpop', 'RoMusic', 'spop', 'somluso', 'UKbands', 'WorldMusic', '70s', 'Acappella', 'AcousticCovers', 'ambientfolk', 'animemusic', 'BestOfDisney', 'boomswing', 'bossanova', 'carmusic', 'concerts', 'chillmusic', 'cpop', 'Complextro', 'dembow', 'disco', 'DreamPop', 'dub', 'Elephant6', 'ETIMusic', 'Exotica', 'FilmMusic', 'FunkSouMusic', 'gamemusic', 'GamesMusicMixMash', 'GunslingerMusic', 'GypsyJazz', 'IndieFolk', 'jambands', 'jazz', 'JazzFusion', 'JazzInfluence', 'listentoconcerts', 'klezmer', 'lt10k', 'MedievalMusic', 'MelancholyMusic', 'minimalism_music', 'motown', 'MusicForConcentration', 'muzyka', 'NuDisco', 'oldiemusic', 'OldiesMusic', 'pianocovers', 'popheads', 'PoptoRock', 'QuietStorm', 'rainymood', 'recordstorefinds', 'reggae', 'remixxd', 'RetroMusic', 'rnb', 'rootsmusic', 'SalsaMusic', 'Ska', 'Soca', 'songbooks', 'Soulies', 'SoulDivas', 'SoundsVintage', 'SpaceMusic', 'SurfPunk', 'swing', 'Tango', 'TheRealBookVideos', 'TouhouMusic', 'TraditionalMusic', 'treemusic', 'triphop', 'vaporwave', 'VintageObscura', 'vocaloid', 'audioinsurrection', 'albumaday', 'albumoftheday', 'Albums', 'albumlisteners', 'bassheavy', 'BinauralMusic', 'BoyBands', 'Catchysongs', 'Chopping', 'CircleMusic', 'CoverSongs', 'cyberpunk_music', 'DANCEPARTY', 'danktunes', 'deepcuts', 'EarlyMusic', 'earlymusicalnotation', 'FemaleVocalists', 'festivals', 'findaband', 'FitTunes', 'FreeAlbums', 'freemusic', 'Frisson', 'gameofbands', 'GayMusic', 'germusic', 'gethightothis', 'GuiltyPleasureMusic', 'HeadNodders', 'heady', 'HeyThatWasIn', 'HighFidelity', 'ifyoulikeblank', 'ilikethissong', 'indie', 'IndieWok', 'Indieheads', 'Instrumentals', 'ipm', 'IsolatedVocals', 'LeeHallMusic', 'LetsTalkMusic', 'listentoconcerts', 'listentodynamic', 'listentomusic', 'listentonews', 'ListenToThis', 'ListenToUs', 'livemusic', 'llawenyddhebddiwedd', 'LongerJams', 'Lyrics', 'mainstreammusic', 'makemeaplaylist', 'MiddleEasternMusic', 'MLPtunes', 'Music', 'MusicAlbums', 'musicanova', 'musicsuggestions', 'MusicToSleepTo', 'musicvideos', 'NameThatSong', 'NewAlbums', 'newmusic', 'onealbumaweek', 'partymusic', 'RedditOriginals', 'RepublicOfMusic', 'RoyaltyFreeMusic', 'runningmusic', 'ScottishMusic', 'SlavicMusicVideos', 'songwriterscircle', 'SpotifyMusic', 'ThemVoices', 'TodaysFavoriteSong', 'unheardof', 'WhatIListenTo', 'WTFMusicVideos', 'AlbumArtPorn', 'albumreviews', 'Audio', 'Audiophile', 'audiophilemusic', 'AustinMusicians', 'bandmembers', 'CarAV', 'CassetteCulture', 'Cd_collectors', 'ConcertTickets', 'germusic', 'glastonbury_festival', 'ICoveredASong', 'ifyoulikeblank', 'independentmusic', 'ineedasong/', 'japanesemusic', 'Jazzguitar', 'koreanmusic', 'LubbockMusicians', 'mixcd', 'musiccritics', 'MusicalComedy', 'musicessentials', 'MusicEventMeetUp', 'musicfestivals', 'musicnews', 'MusiciansBlogs', 'Musicians', 'MusicProduction', 'NeedVocals', 'OSOM', 'performer', 'RecordClub', 'recordstore', 'redditmusicclub', 'Rockband', 'RockbandChallenges', 'TheSongRemainsTheSame', 'TipOfMyTongue', 'TouringMusicians', 'vinyl', 'VinylReleases', 'WeAreTheMusicMakers', '300Songs', 'AcousticOriginals', 'BedroomBands', 'Composer', 'ICoveredASong', 'independentmusic', 'MusicCritique', 'MusicInTheMaking', 'MyMusic', 'RadioReddit', 'RoastMyTrack', 'ratemyband', 'Songwriters', 'TheseAreOurAlbums', 'ThisIsOurMusic', 'UserProduced', 'WereOnSpotify', 'WhiteLabels', '311', 'ADTR', 'AliciaKeys', 'ArcadeFire', 'ArethaFranklin', 'APerfectCircle', 'AvengedSevenfold', 'TheAvettBrothers', 'BABYMETAL', 'Bangtan', 'BaysideIsACult', 'TheBeachBoys', 'Beatles', 'billytalent', 'Blink182', 'BMSR', 'BoBurnham', 'boniver', 'brandnew', 'BruceSpringsteen', 'Burial', 'ChanceTheRapper', 'cher', 'ChiefKeef', 'ChristinaAguilera', 'cityandcolour', 'Coldplay', 'CutCopy', 'TheCure', 'DaftPunk', 'DavidBowie', 'Deadmau5', 'DeathCabforCutie', 'DeathGrips', 'DeepPurple', 'Deftones', 'DieAntwoord', 'DMB', 'donaldglover', 'Drizzy', 'elliegoulding', 'Eminem', 'empireofthesun', 'EnterShikari', 'Evanescence', 'FallOutBoy', 'feedme', 'FirstAidKit', 'flaminglips', 'fleet_foxes', 'Foreigner', 'FrankOcean', 'franzferdinand', 'finkworld', 'Ghostbc', 'Gorillaz', 'grateful_dead', 'Greenday', 'GunsNRoses', 'Incubus', 'JackJohnson', 'JackWhite', 'JanetJackson', 'JackJohnson', 'Kanye', 'KendrickLamar', 'kings_of_leon', 'Korn', 'ladygaga', 'lanadelrey', 'lennykravitz', 'Led_Zeppelin', 'lorde', 'macdemarco', 'Macklemore', 'Madonna', 'Madlib', 'Manowar', 'MariahCarey', 'MattAndKim', 'Megadeth', 'Metallica', 'mfdoom', 'MGMT', 'MichaelJackson', 'MinusTheBear', 'ModestMouse', 'Morrissey', 'mrbungle', 'MyChemicalRomance', 'Muse', 'NeilYoung', 'NIN', 'Nirvana', 'NOFX', 'oasis', 'officialbadcompany', 'ofMontreal', 'OfMonstersAndMen', 'OFWGKTA', 'Opeth', 'OutKast', 'panicatthedisco', 'PearlJam', 'phish', 'Pinback', 'PinkFloyd', 'ThePolice', 'porcupinetree', 'prettylights', 'Puscifer', 'Queen', 'Radiohead', 'RATM', 'RedHotChiliPeppers', 'RelientK', 'rhymesandbeats', 'RiseAgainst', 'robertplant', 'SaveMoneyCrew', 'SigurRos', 'Slayer', 'slipknot', 'SmashingPumpkins', 'SOCOTRAband', 'SparksFTW', 'TameImpala', 'TaylorSwift', 'TeganAndSara', 'TheKillers', 'TheMagneticZeros', 'TheOffspring', 'thepixies', 'The_Residents', 'TheStrokes', 'TheWeeknd', 'tmbg', 'ToolBand', 'tragicallyhip', 'trunknation', 'TwentyOnePilots', 'U2Band', 'Umphreys', 'UnicornsMusic', 'velvetunderground', 'Ween', 'weezer', 'WeirdAl', 'yesband', 'Zappa', 'AlbumArtPorn', 'BandPorn', 'concertporn', 'guitarPorn', 'HipHopImages', 'InstrumentPorn', 'MetalMemes', 'MusicBattlestations', 'MusicPics', 'DJs', 'PirateRadio', 'Spotify', 'Turntablists', 'abletonclass', 'bandmembers', 'basslessons', 'earlymusicalnotation', 'Ethnomusicology', 'ExplainThisSong', 'GuitarLessons', 'LearnMusic', 'MusicEd', 'musicindustry', 'MusicInstructor', 'musicology', 'MusicTheory', 'solresol', 'tabs', 'Accordion', 'banjo', 'Bass', 'bassplaying', 'Bassoon', 'beatbox', 'brass', 'Cello', 'Clarinet', 'ClassicalGuitar', 'Concertina', 'DoubleBass', 'Drummers', 'Drums', 'Flute', 'Guitar', 'GuitarPlaying', 'hammondorgan', 'handpan', 'harmonica', 'Horn', 'keys', 'luthier', 'Mandolin', 'Oboe', 'Ocarina', 'Percussion', 'Percussionists', 'Piano', 'Piccolo', 'PlayingGuitar', 'Recorder', 'saxophone', 'saxophonics', 'Singing', 'synthesizers', 'Telecaster', 'Trombone', 'Trumpet', 'tuba', 'ukulele', 'viola', 'Violinist', 'AudioEngineering', 'EDMproduction', 'FL_Studio', 'ableton', 'AbletonLive', 'AudioPost', 'Cubase', 'futurebeatproducers', 'GameAudio', 'linuxaudio', 'LocationSound', 'Logic_Studio', 'makinghiphop', 'MaxMSP', 'ProductionLounge', 'Protools', 'RateMyAudio', 'Reaper', 'Reasoners', 'Remix', 'Renoise', 'Samplehunters', 'SongStems', 'VSTi:', 'DIYGear', 'diyguitar', 'Gear4Sale', 'GuitarPedals', 'skullcandy', 'Synthesizers'];
my_insert = "e22ca836a309" // don't delete this

//initialize firebase
var firebaseConfig = {
  apiKey: "AIzaSyA9siLziz2yFElLNJ3d_1_6nNs42IW_jAs",
  authDomain: "minty-tracks.firebaseapp.com",
  databaseURL: "https://minty-tracks.firebaseio.com",
  projectId: "minty-tracks",
  storageBucket: "minty-tracks.appspot.com",
  messagingSenderId: "625017438260",
  appId: "1:625017438260:web:193c815376abc62b"
};

firebase.initializeApp(firebaseConfig);
var database = firebase.database();

//onclick for btnAdd button to push user subreddits into checkboxes
$("#btnAdd").on("click", function () {
  var musicSub = $("#newSub").val().trim();
  var timeframe = $("#timeframe").val();

  if (!musicSub) {

  }
  else {

    $("#newSub").val("")
    var newSub = {
      "musicSub": musicSub,
      "timeframe": timeframe
    };

    database.ref().push(newSub);
  };
});

//database function to populate .checkboxSub
database.ref().on("child_added", function (childSnapshot) {
  var musicSub = childSnapshot.val().musicSub;
  var timeframe = childSnapshot.val().timeframe;

  $("#checkboxSub").prepend('<p>' +
    '<label>' +
    '<input type="checkbox" class="musicSub" musicSub=' + musicSub + ' timeframe=' + timeframe + ' id="' + musicSub + "_" + timeframe + '" />' +
    '<span>' + musicSub + "  in the last " + timeframe + '</span>' +
    '</label>' +
    '</p>')
});

//onclick for search button
$("#search").on("click", function () {
  // FOR each entry in #checkboxSub
  var list_of_subs = [];
  $(".musicSub").each(function (i) {
    // console.log($(this).prop('checked'))
    // console.log(this)
    if ($(this).prop('checked')) {

      var ms = $(this).attr('musicSub');
      var tf = $(this).attr('timeframe');
      list_of_subs.push([ms, tf]);
      //console.log(list_of_subs);
    }
  });

  // ASSEMBLY LINE IS DEPRICATED

  // This function is the beginning of the callback chain.
  reddit_call(list_of_subs);


});

//interactive element functionality
$(document).ready(function () {
  $('select').formSelect();
  $('.dropdown-trigger').dropdown();
});



var reddit_call = function (list_of_subs) {
  /*
  DESCRIPTION:
    Convert subreddit + timeframe to a list of useable youtube video IDs

  INPUTS:
          EXAMPLES:
              "50sMusic","all"   <<<<<========== PASS IN SOMETHING LIKE THIS
              "guitar","month"
              "dubstep","week"                   GET SOMETHING LIKE THIS BACK
                                               ||
  RESPONSE:                                    ||
          EXAMPLE:                             ||
          {                                    \/
              zBzZJd-nfw: {title: "Marty Robbins - El Paso (1959)", url: "https://www.youtube.com/watch?v=-zBzZJd-nfw&amp;index=12&amp;list=PLoFQzfvcvGcVHBAv0PkN17iLA_n0aQNme"}
              FyM8NVl4yBY: {title: "The Platters - The Great Pretender (1955)", url: "https://www.youtube.com/watch?v=FyM8NVl4yBY&amp;app=desktop&amp;persist_app=1"}
              PwXai-sgM-s: {title: "Screamin' Jay Hawkins - I Put A Spell On You", url: "https://www.youtube.com/watch?v=PwXai-sgM-s"}
              SDtVAM80zbg: {title: "The Chordettes - Mr. Sandman", url: "https://www.youtube.com/watch?v=SDtVAM80zbg"}
              VJcGi4-n_Yw: {title: "Earth Angel - The Penguins 1955 ", url: "http://www.youtube.com/watch?v=VJcGi4-n_Yw"}
              kLBWkM0jzK0: {title: "Buddy Holly - Everyday", url: "http://www.youtube.com/watch?v=kLBWkM0jzK0"}
              m8OlDPqYBLw: {title: "Bobby Darin - Beyond The Sea (1959)", url: "https://www.youtube.com/watch?v=m8OlDPqYBLw"}
              oNuX7bs2qAM: {title: "The Chordettes - Mr. Sandman", url: "http://www.youtube.com/watch?v=oNuX7bs2qAM"}
              pFABN2EydC8: {title: "Come Go With Me - The Del-Vikings", url: "https://youtu.be/pFABN2EydC8"}
          }
  */

  var all_jams = {};


  for (var il = 0, size = list_of_subs.length; il < size; il++) {
    sub = list_of_subs[il][0]
    time = list_of_subs[il][1]
    // console.log(sub, time)
    reddit.top(sub).t(time).limit(100).fetch(function (res) {
      // console.log(res);
      kids = res.data.children;
      for (var i = 0; i < kids.length && i < 10; i++) {

        if (validateYouTubeUrl(kids[i].data.url)) {
          var key = validateYouTubeUrl(kids[i].data.url);
          var new_item = {
            'title': kids[i].data.title,
            'url': kids[i].data.url
          }
          all_jams[key] = new_item;
        };
      }
      if (il >= size - 1) {
        find_artist_title(all_jams);
      }
    });
  }

}

// SEPARATE FXN FOR VALIDATIONG YOUTUBE LINKS
function validateYouTubeUrl(url) {
  if (url != undefined || url != '') {
    var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=|\?v=)([^#\&\?]*).*/;
    var match = url.match(regExp);
    if (match && match[2].length == 11) {
      return (match[2]);
    }
  }
  return (false);
}


function find_artist_title(all_jams) {


  /*
    attaches ARTIST and SONG_NAME to the object and invokes the get_bpm method
  */
  var all_keys = Object.keys(all_jams)
  // console.log(all_jams)

  // check if the property/key is defined in the object itself, not in parent
  for (key of all_keys) {
    search_terms = all_jams[key].title;

    var artist = ''
    var song_name = ''
    try {
      var chunk = "i_k"; // This is meant to foil someone trying to steal my key
      var my_search = "http://ws.audioscrobbler.com/2.0/?method=track.search&track=" + search_terms + "&ap" + chunk + "ey=e17316" + my_insert + "1938a2303a8f6e&format=json";
      var msg = $.ajax({ type: "GET", url: my_search, async: false }).responseText;
      var msg_json = JSON.parse(msg);
      artist = msg_json.results.trackmatches.track[0].artist
      song_name = msg_json.results.trackmatches.track[0].name
    }
    catch (error) {
      var artist = ''
      var song_name = ''
    }
    all_jams[key].artist = artist;
    all_jams[key].song_name = song_name;
  }
  bpm_call(all_jams);
} // end find_artist_title

var bpm_call_converter = function (str) {
  console.log("str is", str);
  //Description: reformats from jams object into readable search terms for bpm_call
  var convertedString = str.replace(/ /g, "+").toLowerCase();
  return convertedString;
}

var bpm_call = function (jams) {
  // console.log(jams);
  // Description: given song_name and artist,make a call for the bpm of the song and add it into the object

  // Inputs: all_jams object

  // Outputs: all_jams object with a bpm value added to each jam
  var values = Object.values(jams);
  var keys = Object.keys(jams);
  console.log("$$$$ ", values, keys)
  var dropdown = $("<li>");
  var playlistTitle = $("<div>");
  var songInfo = $("<div>");
  playlistTitle.addClass('collapsible-header');
  playlistTitle.text("Playlist");
  songInfo.addClass("collapsible-body");
  dropdown.addClass('collapsible');
  dropdown.attr('id', 'dropdown1');
  var ddTrigger = "<li><a class='dropdown-trigger btn' href='#' data-target='dropdown1'>" + "plName" + "</a></li>"
  $.each(jams, function (i, item) {
    console.log("item:", item);
    var query = "https://cors-anywhere.herokuapp.com/https://api.getsongbpm.com/search/?api_key=2a441a2819558dd13072a3f2fd42d9d8&type=both&lookup=song:" + bpm_call_converter(item.song_name) + "artist:" + bpm_call_converter(item.artist);
    $.getJSON(query, (function (res) {
      // console.log(res);     //<<---- okay so what's happening is this... 
      var song = res.search[0];
      jams[i].bpm = song.tempo; // so here song.tempo has a value    ---    let me think.. so if you access this right here, then you should have access. But as soon as you leave this getJSON scope, then it is no
      // console.log(jams);    //<<---- Console.log is lying to you. I can prove it
      // console.log(Object.keys(jams));  //<---- this will come back empty because it IS empty at the time we go through this. It's just a promise.
      dropdown.append('<li><a href="#!">' + jams[i].song_name + " " + jams[i].artist + " " + "bpm: " + song.tempo + '</a></li>')
    }));
  });
  $("#playlist-area").append(ddTrigger);
  $("#playlist-area").append(dropdown);
}


// UNIT TEST
var testJams = {
  key1: { song_name: "Enter Sandman", artist: "Metallica", url: "https://www.youtube.com/watch?v=-zBzZJd-nfw&amp;index=12&amp;list=PLoFQzfvcvGcVHBAv0PkN17iLA_n0aQNme", },
  key2: { song_name: "Call Me Maybe", artist: "Carly Rae Jepsen", url: "https://www.youtube.com/watch?v=FyM8NVl4yBY&amp;app=desktop&amp;persist_app=1", }
}

// bpm_call(testJams);
// // UNIT TEST
// VideoIDs = reddit_call("50sMusic", "all");

